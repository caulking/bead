<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Span + Slider Rating</title>
  <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&amp;display=swap" rel="stylesheet">
  <link href="../css/gallery.css" rel="stylesheet">
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="../js/gallery-bundle.js"></script>
</head>
<body>
  <div class="gallery-demo">
    <div id="jspsych-target"></div>
    <div id="response-display"></div>
  </div>
  <script>
    function fixSubscriptOverlaps(container) {
      var badges = Array.from(container.querySelectorAll(".bead-span-subscript"));
      if (badges.length < 2) return;
      badges.forEach(function(b) { b.style.transform = ""; });
      badges.sort(function(a, b) { return a.getBoundingClientRect().left - b.getBoundingClientRect().left; });
      var placed = [];
      badges.forEach(function(badge) {
        var rect = badge.getBoundingClientRect();
        var shift = 0, hasOverlap = true, iter = 0;
        while (hasOverlap && iter < 10) {
          hasOverlap = false;
          for (var p = 0; p < placed.length; p++) {
            var pr = placed[p].rect;
            if (rect.left < pr.right + 3 && rect.right > pr.left - 3 && rect.top < pr.bottom + 1 && rect.bottom > pr.top - 1) {
              shift += pr.bottom - rect.top + 2;
              badge.style.transform = "translateY(" + shift + "px)";
              rect = badge.getBoundingClientRect();
              hasOverlap = true; break;
            }
          }
          iter++;
        }
        placed.push({ el: badge, rect: badge.getBoundingClientRect() });
      });
    }

    function renderSpanStimulus(tokens, spaceAfter, spans, palette) {
      var darkPalette = ["#1565C0", "#2E7D32", "#E65100", "#AD1457", "#4527A0", "#00838F", "#558B2F", "#F9A825"];
      var spanLight = {}, spanDark = {}, ci = 0;
      spans.forEach(function(span) {
        spanLight[span.span_id] = palette[ci % palette.length];
        spanDark[span.span_id] = darkPalette[ci % darkPalette.length];
        ci++;
      });
      var tokenSpanMap = {};
      spans.forEach(function(span, spanIdx) {
        span.segments.forEach(function(seg) {
          seg.indices.forEach(function(idx) {
            if (!tokenSpanMap[idx]) tokenSpanMap[idx] = [];
            tokenSpanMap[idx].push(spanIdx);
          });
        });
      });
      var spanLastToken = {};
      spans.forEach(function(span) {
        var maxIdx = -1;
        span.segments.forEach(function(seg) { seg.indices.forEach(function(idx) { if (idx > maxIdx) maxIdx = idx; }); });
        spanLastToken[span.span_id] = maxIdx;
      });
      var html = '<div class="stimulus-container"><div class="bead-span-container">';
      tokens.forEach(function(token, i) {
        var spanIndices = tokenSpanMap[i] || [];
        if (spanIndices.length > 0) {
          var spanId = spans[spanIndices[0]].span_id;
          var color = spanLight[spanId];
          var leftSpans = tokenSpanMap[i - 1] || [];
          var rightSpans = tokenSpanMap[i + 1] || [];
          var hasLeft = spanIndices.some(function(si) { return leftSpans.indexOf(si) >= 0; });
          var hasRight = spanIndices.some(function(si) { return rightSpans.indexOf(si) >= 0; });
          var pos = hasLeft && hasRight ? "middle" : hasLeft ? "last" : hasRight ? "first" : "single";
          var subscript = "";
          spans.forEach(function(span) {
            if (spanLastToken[span.span_id] === i && span.label) {
              subscript += '<span class="bead-span-subscript" style="background-color:' + spanDark[span.span_id] + '">' + span.label.label + '</span>';
            }
          });
          html += '<span class="bead-token highlighted span-' + pos + '" style="background-color:' + color + ';position:relative">' + token + subscript + '</span>';
          if (spaceAfter[i]) {
            if (hasRight) {
              html += '<span class="bead-space highlighted" style="background-color:' + color + '"> </span>';
            } else { html += ' '; }
          }
        } else {
          html += '<span class="bead-token">' + token + '</span>';
          if (spaceAfter[i]) html += ' ';
        }
      });
      html += '</div></div>';
      return html;
    }

    function runDemo() {
      var target = document.getElementById("jspsych-target");
      target.innerHTML = "";
      document.getElementById("response-display").innerHTML = "";

      var jsPsych = initJsPsych({
        display_element: "jspsych-target",
        on_finish: function() {
          var data = jsPsych.data.get().last(1).values()[0];
          var display = document.getElementById("response-display");
          display.innerHTML =
            '<div class="gallery-response-label">Response Data</div>' +
            '<div class="gallery-response">' + JSON.stringify(data, null, 2) + '</div>' +
            '<button class="gallery-reset" onclick="runDemo()">Reset Demo</button>';
        }
      });

      var tokens = ["Jo", "confirmed", "that", "Bo", "left", "."];
      var spaceAfter = [true, true, true, true, false, false];
      var palette = ["#BBDEFB", "#C8E6C9", "#FFE0B2", "#F8BBD0", "#D1C4E9", "#B2EBF2", "#DCEDC8", "#FFD54F"];
      var spans = [
        {span_id: "span_0", segments: [{element_name: "text", indices: [1]}], label: null},
        {span_id: "span_1", segments: [{element_name: "text", indices: [3, 4]}], label: null}
      ];

      var stimulus = renderSpanStimulus(tokens, spaceAfter, spans, palette);

      var question = 'How likely is it that ' +
        '<span class="bead-q-highlight" style="background:#C8E6C9">someone left</span>?';

      var trial = {
        type: BeadSliderRatingPlugin,
        prompt: stimulus + '<p style="color:#424242;font-size:1.1em;margin-top:16px">' + question + '</p>',
        slider_min: 0,
        slider_max: 100,
        slider_start: 50,
        labels: ["Certainly did not happen", "Certainly happened"],
        require_movement: true,
        button_label: "Continue",
        on_load: function() { fixSubscriptOverlaps(document.getElementById("jspsych-target")); },
        metadata: {
          verb: "confirm",
          frame: "that_S",
          item_id: "veridicality-confirm-that-s"
        }
      };

      jsPsych.run([trial]);
    }

    runDemo();
  </script>
  <script>(function(){var last=0;new ResizeObserver(function(){var h=document.documentElement.scrollHeight;if(h!==last){last=h;window.parent.postMessage({type:'bead-resize',height:h},'*');}}).observe(document.body);})()</script>
</body>
</html>
